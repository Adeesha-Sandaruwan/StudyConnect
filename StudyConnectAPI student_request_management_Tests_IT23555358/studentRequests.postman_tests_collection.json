{
  "info": {
    "name": "StudyConnect - Student Requests (with tests)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "1.0.0"
  },
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:5000" },
    { "key": "jwt", "value": "" },
    { "key": "requestId", "value": "" }
  ],
  "item": [
    {
      "name": "Login as Student",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{ \"email\": \"student@example.com\", \"password\": \"password\" }" },
        "url": "{{baseUrl}}/api/users/auth"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('login status is 200', function () { pm.response.to.have.status(200); });",
              "// extract jwt from Set-Cookie header",
              "var setCookie = pm.response.headers.get('set-cookie');",
              "if (setCookie) {",
              "  var m = setCookie.match(/jwt=([^;]+);?/);",
              "  if (m && m[1]) { pm.environment.set('jwt', m[1]); }",
              "}",
              "pm.test('jwt cookie stored', function() { pm.expect(pm.environment.get('jwt')).to.not.be.undefined; });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Create Request (valid)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{jwt}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"subject\": \"Science\",\n  \"description\": \"Need help with science related questions.\",\n  \"gradeLevel\": \"Grade 11\",\n  \"requestType\": \"one-time\",\n  \"preferredSchedule\": [\"Monday 5-6 PM\", \"Wednesday 4-5 PM\"],\n  \"priority\": \"high\"\n}"
        },
        "url": "{{baseUrl}}/api/student-requests"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('create status is 201', function () { pm.response.to.have.status(201); });",
              "var json = pm.response.json();",
              "pm.test('response has request object', function() { pm.expect(json).to.have.property('request'); });",
              "if (json.request && json.request._id) { pm.environment.set('requestId', json.request._id); }",
              "pm.test('requestId saved', function() { pm.expect(pm.environment.get('requestId')).to.not.be.empty; });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Create Request (invalid)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Authorization", "value": "Bearer {{jwt}}" } ],
        "body": { "mode": "raw", "raw": "{ \"subject\": \"Science\" }" },
        "url": "{{baseUrl}}/api/student-requests"
      },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('invalid create returns 400', function(){ pm.response.to.have.status(400); });" ], "type": "text/javascript" } } ]
    },
    {
      "name": "Get All Requests",
      "request": { "method": "GET", "header": [], "url": "{{baseUrl}}/api/student-requests" },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('get all returns 200', function(){ pm.response.to.have.status(200); });" ], "type": "text/javascript" } } ]
    },
    {
      "name": "Get My Requests",
      "request": { "method": "GET", "header": [ { "key": "Authorization", "value": "Bearer {{jwt}}" } ], "url": "{{baseUrl}}/api/student-requests/my-requests" },
      "event": [ { "listen": "test", "script": { "exec": [ "pm.test('get my requests returns 200', function(){ pm.response.to.have.status(200); });" ], "type": "text/javascript" } } ]
    },
    {
      "name": "Get Request By Id",
      "request": { "method": "GET", "header": [], "url": "{{baseUrl}}/api/student-requests/:id" },
      "event": [ { "listen": "prerequest", "script": { "exec": [ "if(!pm.environment.get('requestId')) { throw new Error('requestId not set'); }" ], "type": "text/javascript" } }, { "listen": "test", "script": { "exec": [ "pm.test('get by id returns 200', function(){ pm.response.to.have.status(200); });" ], "type": "text/javascript" } } ],
      "url": { "raw": "{{baseUrl}}/api/student-requests/{{requestId}}", "host": [ "{{baseUrl}}" ], "path": [ "api", "student-requests", "{{requestId}}" ] }
    },
    {
      "name": "Update Request (partial)",
      "request": {
        "method": "PUT",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Authorization", "value": "Bearer {{jwt}}" } ],
        "body": { "mode": "raw", "raw": "{ \"description\": \"Updated via tests\" }" },
        "url": "{{baseUrl}}/api/student-requests/:id"
      },
      "event": [ { "listen": "prerequest", "script": { "exec": [ "if(!pm.environment.get('requestId')) { throw new Error('requestId not set'); }" ], "type": "text/javascript" } }, { "listen": "test", "script": { "exec": [ "pm.test('update returns 200', function(){ pm.response.to.have.status(200); });" ], "type": "text/javascript" } } ],
      "url": { "raw": "{{baseUrl}}/api/student-requests/{{requestId}}", "host": [ "{{baseUrl}}" ], "path": [ "api", "student-requests", "{{requestId}}" ] }
    },
    {
      "name": "Update Request Status",
      "request": {
        "method": "PUT",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Authorization", "value": "Bearer {{jwt}}" } ],
        "body": { "mode": "raw", "raw": "{ \"status\": \"in-progress\" }" },
        "url": "{{baseUrl}}/api/student-requests/:id/status"
      },
      "event": [ { "listen": "prerequest", "script": { "exec": [ "if(!pm.environment.get('requestId')) { throw new Error('requestId not set'); }" ], "type": "text/javascript" } }, { "listen": "test", "script": { "exec": [ "pm.test('status update returns 200', function(){ pm.response.to.have.status(200); });" ], "type": "text/javascript" } } ],
      "url": { "raw": "{{baseUrl}}/api/student-requests/{{requestId}}/status", "host": [ "{{baseUrl}}" ], "path": [ "api", "student-requests", "{{requestId}}", "status" ] }
    },
    {
      "name": "Delete Request",
      "request": {
        "method": "DELETE",
        "header": [ { "key": "Authorization", "value": "Bearer {{jwt}}" } ],
        "url": "{{baseUrl}}/api/student-requests/:id"
      },
      "event": [ { "listen": "prerequest", "script": { "exec": [ "if(!pm.environment.get('requestId')) { throw new Error('requestId not set'); }" ], "type": "text/javascript" } }, { "listen": "test", "script": { "exec": [ "pm.test('delete returns 200', function(){ pm.response.to.have.status(200); });" ], "type": "text/javascript" } } ],
      "url": { "raw": "{{baseUrl}}/api/student-requests/{{requestId}}", "host": [ "{{baseUrl}}" ], "path": [ "api", "student-requests", "{{requestId}}" ] }
    }
  ]
}
